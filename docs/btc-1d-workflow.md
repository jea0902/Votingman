# 1일봉(btc_1d) 워크플로우

**btc_1d는 UTC 00:00 기준**으로 Binance 1d와 동일하게 맞춰 두었습니다.  
목표가·차트·정산이 **Binance 전일 종가**와 일치합니다.

데이터 수집 → 투표 → 투표 마감 → 정산 순서와, **목표가가 언제 어떻게 조회되는지** 정리합니다.

---

## 1. 타임라인 요약 (예: 2월 16일 1일봉)

| 단계 | 시점 (KST) | 내용 |
|------|------------|------|
| 봉 시작 | 2월 16일 **00:00** | 2월 16일 1일봉 시작 (이 봉으로 투표·정산 대상) |
| 데이터 수집 | 2월 16일 **00:01** | **전날(2월 15일) 봉** 수집 → btc_ohlc 저장 (2월 16일 봉의 **목표가**가 됨) |
| 투표 | 2월 16일 00:00 ~ **12:00** | 사용자가 2월 16일 봉 UP/DOWN 투표 |
| 투표 마감 | 2월 16일 **12:00** | 이후 투표·취소 불가 |
| 정산 | 2월 **17일** **00:01** | 2월 16일 봉 수집 + 정산 실행 (당첨자 지급 등) |

---

## 2. 단계별 설명

### 2.1 데이터 수집

- **실행**: 매일 **KST 00:01** 크론 (`/api/cron/btc-ohlc-daily`)
- **하는 일**:
  1. **방금 마감된 1일봉**을 Binance에서 가져와 `btc_ohlc`에 저장  
     - 00:01에 수집하는 건 **전날 00:00에 시작해 오늘 00:00에 마감된 봉** = **어제 봉**
  2. (같은 크론에서) 어제 봉에 해당하는 폴 **정산** 실행 (아래 2.4 참고)

- **예 (2월 16일 00:01 실행)**  
  - 2월 **15일** 1일봉(15일 00:00 ~ 16일 00:00) 수집 → DB에 `(btc_1d, 2월15일 00:00 candle_start_at)` 행 저장  
  - 이 행의 **close** = 2월 15일 종가 = **2월 16일 봉의 목표가**가 됨

즉, “오늘 00:01 수집”으로 **어제 봉**이 DB에 들어가고, 그 **종가**가 “오늘 봉”의 목표가로 쓰입니다.

### 2.2 투표

- **대상 봉**: 당일 00:00 KST에 **시작한** 1일봉 (예: 2월 16일 00:00 시작 봉)
- **가능 시간**: 당일 00:00 ~ **12:00 KST** (시장 규칙상 투표 마감 12:00)
- **내용**: 그 봉이 **목표가(이전 봉 종가) 대비** UP인지 DOWN인지 투표

### 2.3 목표가가 언제·어떻게 조회되는지

- **저장되는 시점이 아님**: 목표가는 “어떤 테이블에 미리 저장해 두는 값”이 아니라, **API가 응답할 때마다 조회해서 넣는 값**입니다.
- **조회 시점**: 사용자가 **투표 상세 페이지** 또는 **투표 목록 페이지**를 열 때  
  → `GET /api/sentiment/poll?market=btc_1d` 또는 `GET /api/sentiment/polls` 호출  
  → 그때 서버에서 **목표가 = 이전 봉 종가**를 계산해 응답에 실어 보냄.

- **조회 방법** (1일봉 포함 모든 BTC 시간봉 동일):
  1. **이전 봉**의 `candle_start_at` 계산  
     - 2월 16일 봉이면 이전 봉 = 2월 15일 00:00 봉
  2. **btc_ohlc**에서 `(market=btc_1d, candle_start_at=이전 봉)` 행 조회  
     - 있으면 → 그 행의 **close** = 목표가
  3. 없으면 (크론 전이거나 이슈 시) **Binance**에서 이전 봉 1개 조회 후 **close** 사용

- **2월 16일 봉 기준**  
  - 2월 16일 **00:01 크론 이후**에는 2월 15일 봉이 이미 btc_ohlc에 있으므로, 페이지를 열 때마다 **DB의 2월 15일 봉 close**가 목표가로 나감.  
  - 2월 16일 **00:00~00:01** 사이에 페이지를 열면 2월 15일 봉이 아직 DB에 없을 수 있어, 이때는 **Binance fallback** 사용.  
  - **1일봉 fallback 시 주의**: Binance 1d 봉은 **UTC 00:00** 기준, 우리 1일봉은 **KST 00:00(= UTC 전날 15:00)** 기준이라 정렬이 다름. 따라서 fallback 시 Binance `interval=1d`를 쓰지 않고, **1h 봉 24개**를 묶어 이전 봉 종가(마지막 1h 봉의 close)를 사용함. 그렇지 않으면 UTC 자정 봉을 가져와 진행 중인 봉의 close(= 현재가)가 목표가로 나오는 버그가 발생함.

정리하면, 목표가는 **페이지를 열 때마다 “이전 봉 종가”를 DB 또는 Binance에서 조회**해서 응답에 넣고, 별도로 “목표가만 저장하는” 단계는 없습니다.

### 2.4 투표 마감

- **시점**: 당일 **12:00 KST** (1일봉 시장 규칙)
- **이후**: 해당 봉에 대한 투표·취소 불가 (이미 확정된 투표는 애초에 수정 불가)

### 2.5 정산

- **실행**: **다음날** **KST 00:01** 크론 (같은 `/api/cron/btc-ohlc-daily`)
- **하는 일** (1d):
  1. **방금 마감된 1일봉** 수집  
     - 2월 17일 00:01이면 → 2월 **16일** 1일봉(16일 00:00 ~ 17일 00:00) 수집 → btc_ohlc 저장
  2. **정산**  
     - `settlePoll("2026-02-16", "btc_1d")`  
     - 2월 16일 봉의 reference_close(시가 = 2월 15일 봉 종가) vs settlement_close(2월 16일 봉 종가) 비교  
     - 당첨자 판정, 수수료 차감 후 지급, payout_history 기록 등

---

## 3. 흐름도 (1일봉 한 봉 기준)

```
[2월 15일 00:00]  2월 15일 봉 시작
        │
        ▼
[2월 16일 00:00]  2월 15일 봉 마감, 2월 16일 봉 시작
        │
        ▼
[2월 16일 00:01]  크론: 2월 15일 봉 수집 → btc_ohlc 저장
        │          → 2월 16일 봉의 "목표가" = 이 봉의 close 로 조회 가능
        ▼
[2월 16일 00:00 ~ 12:00]  투표 기간
        │                  목표가 = 페이지 열 때마다 DB(또는 Binance)에서 "이전 봉(2/15) close" 조회
        ▼
[2월 16일 12:00]  투표 마감
        │
        ▼
[2월 17일 00:00]  2월 16일 봉 마감
        │
        ▼
[2월 17일 00:01]  크론: 2월 16일 봉 수집 → btc_ohlc 저장
        │          → 2월 16일 봉 정산 (당첨자 지급 등)
        ▼
        끝
```

---

## 4. 요약

- **데이터 수집**: 매일 00:01에 **어제 1일봉** 수집 → btc_ohlc 저장.  
  이 **어제 봉의 close**가 **오늘 봉의 목표가**가 됨.
- **투표**: 당일 00:00 ~ 12:00, “오늘 봉” UP/DOWN.
- **목표가 조회**: DB에 “저장해 두는” 게 아니라, **투표 상세/목록 API가 호출될 때마다** “이전 봉 종가”를 btc_ohlc(또는 Binance)에서 조회해 응답에 포함.
- **투표 마감**: 당일 12:00.
- **정산**: **다음날** 00:01 크론에서 “방금 마감된 1일봉” 수집 후, 해당 봉에 대해 정산 실행.
