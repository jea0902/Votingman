# 목표가(Price to Beat) 계산 방식

투표/예측 페이지에서 표시하는 **목표가**는 **해당 봉의 시가(open)** 입니다.  
봉이 바뀌는 순간에는 “직전 봉의 종가 = 현재 봉의 시가”이므로, **목표가 = 지금 시작하는 캔들의 시가 = 바로 전 캔들의 종가**로 이해하면 됩니다.  
롱/숏 승패는 이 목표가 대비 봉 마감 시점의 **종가(close)** 가 올랐는지/내렸는지로 정산됩니다.

---

## 공통 원리

- **목표가 = 현재 투표 중인 봉의 시가**
- 봉이 **시작된 시각**의 BTC 가격이 시가이므로, 그 시각에 Binance에서 기록된 **해당 봉의 open** 값을 사용합니다.
- 데이터 소스 우선순위:
  1. **btc_ohlc** 테이블에 해당 (market, candle_start_at) 행이 있으면 → 그 행의 `open` 사용
  2. 없으면(봉이 막 시작되어 아직 크론이 넣지 않은 경우) → **Binance Klines API**로 해당 봉 1개 조회 후 `open` 사용

---

## 시간봉별 계산 방법

| 시장 | 봉 주기 | candle_start_at | 목표가(시가) 계산 |
|------|---------|-----------------|-------------------|
| **btc_15m** | 15분 | KST 00:00, 00:15, 00:30, 00:45, 01:00, … (15분 단위) | 해당 15분 봉이 **시작된 시각**의 Binance 15m 봉 `open`. 예: 14:00 KST 시작 봉 → 14:00:00 시점의 15m 캔들 open |
| **btc_1h** | 1시간 | KST 00:00, 01:00, 02:00, … (1시간 단위) | 해당 1시간 봉이 **시작된 시각**의 Binance 1h 봉 `open`. 예: 14:00 KST 시작 봉 → 14:00:00 시점의 1h 캔들 open |
| **btc_4h** | 4시간 | KST 00:00, 04:00, 08:00, 12:00, 16:00, 20:00 | 해당 4시간 봉이 **시작된 시각**의 Binance 4h 봉 `open`. 예: 12:00 KST 시작 봉 → 12:00:00 시점의 4h 캔들 open |
| **btc_1d** | 1일 | KST 00:00 (당일) | 해당 일봉이 **시작된 시각**(당일 KST 00:00 = 전일 UTC 15:00)의 Binance 1d 봉 `open` |

- **candle_start_at**은 모두 **UTC ISO**로 저장됩니다 (예: 2월 13일 14:00 KST → `2026-02-13T05:00:00.000Z`).
- Binance 조회 시: `interval`은 시장별로 15m / 1h / 4h / 1d, `startTime`은 `candle_start_at`을 ms로 변환한 값, `limit=1`로 **해당 봉 1개**만 요청해 그 `open`을 목표가로 씁니다.

---

## 정리

- **15분봉**: 15분 봉 시작 시각의 15m 캔들 시가  
- **1시간봉**: 1시간 봉 시작 시각의 1h 캔들 시가  
- **4시간봉**: 4시간 봉 시작 시각의 4h 캔들 시가  
- **1일봉**: 당일 KST 00:00에 시작한 1d 캔들 시가  

즉, **“지금 투표하는 그 봉이 열릴 때의 가격”**이 목표가이며, DB에 없으면 Binance에서 그 봉의 open을 실시간으로 가져와 표시합니다.
