# 보팅맨 서비스 구현 단계 (Implementation Phases)

기획서(`voting-coin-platform-plan.md`)를 기준으로, **보팅맨** 기능을 2차 MVP 전체가 아닌 **이 서비스만 단계적으로** 구현하기 위한 단계 구분입니다.  
한 단계가 안정된 뒤 다음 단계로 진행하는 것을 권장합니다.

---

## 구현 단계 순서 기준 (재정의)

**원칙**: **가장 기초가 되는 영역이 다른 영역의 초석이 되며, 나중에 수정할 필요가 없을수록 먼저 구현**한다.

### 기준에 대한 피드백

- **“가장 기초”** = 다른 모듈이 이를 **전제**로 하고, 이걸 바꾸면 연쇄 수정이 많이 일어나는 부분. (DB 스키마, 인증·잔액, 배팅·정산의 데이터 구조.)
- **“나중에 수정할 필요가 없을수록”** = 비즈니스 규칙이 이미 확정되었고, 스키마·API 계약이 안정적인 부분. (정산 공식, 시장별 마감 시간, 계정 정책 등.)
- **따라서**
  - **DB·데이터 모델**을 먼저 “확장 가능한 형태”로 확정해 두면, 2~4단계에서 컬럼 추가·마이그레이션을 최소화할 수 있음.
  - 그 다음 **인증·잔액** → **배팅(입력)** → **정산(출력 소비)** 순으로 가면, “배팅 구조를 나중에 바꾸면 정산까지 흔들리는” 상황을 줄일 수 있음.
  - **시장 확장**은 “폴·투표에 시장 구분이 이미 스키마에 있으면” 값만 채우고 로직만 확장하면 됨.
  - **시장세·티어·리더보드**는 그 위에 쌓는 부가 기능이라 상대적으로 나중에 두는 것이 자연스러움.

### 재정의된 구현 단계 (초석 우선 순서)

| 순서  | 단계명                     | 목표 요약                                                             | 왜 이 순서인가                                                                          |
| ----- | -------------------------- | --------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| **1** | **DB·스키마 기초 확정**    | 보팅코인·폴·투표·정산 이력까지 “확장 가능한” 스키마 한 번에 설계·반영 | 스키마를 나중에 바꾸면 마이그레이션·API 전반 수정. 2~5단계에서 추가 스키마 변경 최소화. |
| **2** | **로그인 전제 + 보팅코인** | 로그인한 사람만 투표, 사용자별 보팅코인 잔액 (구글·카카오만)          | 인증·잔액은 모든 투표/배팅의 전제. (1단계 대부분 완료, 카카오 추가.)                    |
| **3** | **포인트 배팅 + 취소**     | 보팅코인 N개 걸기, 롱/숏 비율=코인 수, 마감 전 수정·취소              | 정산의 **입력**. 배팅 구조를 나중에 바꾸면 정산 로직까지 연쇄 수정.                     |
| **4** | **정산 (파리뮤추얼)**      | 종가 확정 후 패자 풀 → 승자 비율 분배, 정산 이력 저장                 | 공식 확정·변경 가능성 낮음. 3단계 출력을 소비하는 핵심.                                 |
| **5** | **3개 시장 확장**          | 비트코인 + 미국 주식 + 한국 주식, 시장별 폴·마감·일봉                 | 스키마에 시장 구분이 있으면 “값 채우고” 로직만 확장. 한 시장(비트코인) 검증 후 확장.    |
| **6** | **시장세 + 과거 시각화**   | 5단계 시장세, 과거 같은 시장세 때 배팅·승률 시각화                    | 4·5 위 부가 기능. 변경 가능성 상대적으로 높음.                                          |
| **7** | **티어·MMR**               | 시즌·배치고사·MMR·티어 (**전체 통합**: 비트코인·미국·한국 한 묶음)     | 정산 이력·승률 위에 구축. 배치 5판 = 전체 시장 중 아무 영역이나 5판 정산. 규칙 조정 가능. |
| **8** | **리더보드 + 홈**          | **통합** TOP 5, 현재 포지션 위젯                                      | 7단계 위 UI. 노출 방식 변경 가능.                                                       |

- **1→2→3→4** 순서는 유지: 포인트 배팅 없이 정산 불가, 정산 없이 시장 확장만 하면 검증이 어려움.
- **5** 이후는 6·7·8 순서대로 진행하면 됨. (기존 5·6·7단계와 대응.)

### 새 1단계: DB·스키마 기초 확정 (구현할 작업)

다음 단계(배팅·정산·다중 시장)에서 스키마를 다시 바꾸지 않도록, **한 번에 확장 가능한 형태**로 반영한다.

| 작업    | 내용                                         | 산출물                                                                                                                                                                                    |
| ------- | -------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1.1** | `users.voting_coin_balance`                  | 이미 반영됨. 확인만.                                                                                                                                                                      |
| **1.2** | `sentiment_votes`에 `bet_amount` 추가        | numeric(10,2), nullable 또는 기본 0. “1인 1표” 시에도 동일 행에 bet_amount 저장.                                                                                                          |
| **1.3** | `sentiment_polls`에 코인 집계·시장 구분 추가 | `long_coin_total`, `short_coin_total` (numeric, 기본 0). `market` (text, nullable, 예: `btc` / `ndq` / `sp500` / `kospi` / `kosdaq`). 기존 비트코인 단일 폴은 `market = 'btc'` 또는 null. |
| **1.4** | 정산 이력 테이블 추가                        | `payout_history`(또는 유사명): poll_id, user_id, market, bet_amount, payout_amount, settled_at 등. 정산 1회 실행 시 당첨자별 1행.                                                         |
| **1.5** | `sentiment_polls` unique 제약 조정           | `(poll_date)` 단일 unique → `(poll_date, market)` 복합 unique (또는 market nullable일 때 poll_date+market). 같은 날짜에 시장별 폴이 여러 개 생길 수 있음.                                 |
| **1.6** | 문서·타입 반영                               | `db-schema.sql`, `db-sentiment-tables.sql`, `src/lib/supabase/db-types.ts` 및 마이그레이션 SQL.                                                                                           |

**의존**: 1단계 완료 후 2단계(로그인·보팅코인)에서 잔액·투표 API, 3단계에서 bet_amount 사용, 4단계에서 정산 이력 저장, 5단계에서 market 값 채우기.

### 단계–문서 대응 (상세 내용 위치)

| 새 순서 | 단계명                 | 본 문서 내 상세 섹션                             |
| ------- | ---------------------- | ------------------------------------------------ |
| 1       | DB·스키마 기초 확정    | 위 표 + 아래 1.1(DB) 참고                        |
| 2       | 로그인 전제 + 보팅코인 | **1단계: 로그인 전제 + 보팅코인 기반** (1.1~1.4) |
| 3       | 포인트 배팅 + 취소     | **2단계: 포인트 배팅**                           |
| 4       | 정산 (파리뮤추얼)      | **3단계: 정산**                                  |
| 5       | 3개 시장 확장          | **4단계: 3개 시장 섹션 확장**                    |
| 6       | 시장세 + 과거 시각화   | **5단계: 시장세 + 과거 데이터 시각화**           |
| 7       | 티어·MMR               | **6단계: 티어 + 랭킹 시스템**                    |
| 8       | 리더보드 + 홈          | **7단계: 리더보드 + 홈 고수 포지션**             |

---

## 단계 요약 (한눈에) — 기존 7단계 참조용

| 단계  | 이름                        | 목표                                               | 산출물                              |
| ----- | --------------------------- | -------------------------------------------------- | ----------------------------------- |
| **1** | 로그인 전제 + 보팅코인 기반 | 투표는 로그인만 허용, 사용자별 보팅코인 잔액 도입  | 로그인 전용 투표, users 보팅코인    |
| **2** | 포인트 배팅으로 전환        | 1인 1표 → “보팅코인 N개 걸기” 배팅                 | 베팅량 저장·집계, 롱/숏 포인트 비율 |
| **3** | 파리뮤추얼 페이아웃         | 당첨자에게 패자 포인트 분배                        | 종가 확정 후 자동 정산·지급         |
| **4** | 3개 시장 섹션 확장          | 비트코인 + 미국주식 + 한국주식 투표                | 폴/투표를 시장·종목별로 분리        |
| **5** | 시장세 + 과거 데이터 시각화 | 5단계 시장세 저장, “과거 같은 시장세 때 결과” 노출 | 시장세 정의·집계, 인간지표 UI 연동  |
| **6** | 가중치 + 티어 시스템        | 고수 가중치 반영, 적중률 티어(배치 5회→브론즈~)    | Voting_Power, 티어 계산·노출        |
| **7** | 리더보드 + 홈 고수 포지션   | TOP 5 리더보드, 실시간 고수 포지션 시각화          | 리더보드 API·UI, 홈 위젯            |

---

## 1단계: 로그인 전제 + 보팅코인 기반

**목표**: “로그인한 사람만 투표”로 바꾸고, 사용자별 **보팅코인 잔액**을 쌓을 수 있는 기반을 만든다.

**1단계 세부 단계 (작은 단위로 진행)**

| 단계    | 내용                             | 산출물                                                           |
| ------- | -------------------------------- | ---------------------------------------------------------------- |
| **1.1** | DB: 보팅코인 잔액 컬럼 이름 변경 | `virtual_cash_balance` → `voting_coin_balance`, 마이그레이션 SQL |
| **1.2** | 초기 보팅코인 지급 규칙          | 신규/기존 사용자 잔액 설정 (예: 1000 코인)                       |
| **1.3** | API: 로그인 필수로 변경          | `POST /api/sentiment/vote` 비로그인 시 401, anonymous_id 제거    |
| **1.4** | UI: 비로그인 시 투표 불가        | 인간 지표 섹션에서 비로그인 시 버튼 비활성 + 로그인 유도         |

**의존 관계**: 1.1 → 1.2 (DB 먼저), 1.3과 1.4는 1.1·1.2와 병렬 가능. 1.3 완료 후 1.4에서 실제 vote API 연동 권장.

---

### 1.1 DB: 보팅코인 잔액 컬럼 이름 변경

- **작업**
  - `public.users` 테이블의 기존 컬럼 **`virtual_cash_balance`** 를 **`voting_coin_balance`** 로 **이름만 변경** (RENAME COLUMN).
  - Supabase 실제 DB 구조: user_id, email, nickname, profile_image, role, allow_notif_tn, allow_notif_bo, created_at, deleted_at, virtual_cash_balance → 이름 변경 후 voting_coin_balance. 타입·기본값(10000) 유지.
  - 프로젝트 내 DB 문서·타입도 동일하게 반영: `db-schema.sql`, `src/lib/supabase/db-types.ts` 의 UserRow.
- **산출물**
  - `docs/migrations/001_rename_virtual_cash_to_voting_coin_balance.sql`
  - `db-schema.sql`, `db-types.ts` 수정 반영.

---

### 1.2 초기 보팅코인 지급

- **작업**
  - **별도 초기 지급 불필요**: 기존 `virtual_cash_balance`에 이미 사용자당 10000이 들어 있으므로, 1.1에서 컬럼 이름만 `voting_coin_balance`로 바꾼 뒤 **그 값을 그대로 보팅코인 잔액으로 사용**.
  - 신규 가입 시에는 DB 기본값(DEFAULT 10000)으로 자동 설정되면 됨.
- **산출물**
  - (선택) 조회용 API에 `voting_coin_balance` 포함.

---

### 1.3 API: 로그인 필수로 변경

- **작업**
  - `POST /api/sentiment/vote`: 요청 시 `user_id`(세션)가 없으면 **401 Unauthorized**, 메시지: "로그인한 사용자만 투표할 수 있습니다."
  - `anonymous_id` 파라미터 제거 또는 무시. 비로그인 요청은 모두 401.
  - `sentiment_votes` INSERT/UPDATE 시 `user_id`만 사용, `anonymous_id`는 `null`만 저장.
- **산출물**
  - `src/app/api/sentiment/vote/route.ts` 수정.

---

### 1.4 UI: 비로그인 시 투표 불가

- **작업**
  - 인간 지표 섹션: **비로그인**이면 롱/숏 버튼 **비활성화** (또는 클릭 시 로그인 유도).
  - 비로그인 시 "로그인하고 투표하세요" + 로그인 버튼은 **항시 표시** (기존 유지).
  - **로그인** 시에만 버튼 활성화하고, 클릭 시 `POST /api/sentiment/vote` 호출 (`anonymous_id` 없이). 필요 시 `GET /api/sentiment/poll`로 비율·시가 등 표시.
- **산출물**
  - `HumanIndicatorSection.tsx` 수정: 로그인 여부에 따라 버튼 disabled, vote API 연동 시 로그인 사용자만 요청.

---

**구현 내용 (참고)**

- **투표 참여 제한**
  - 인간 지표(데일리 투표)에서 **비로그인 투표 제거**.
  - API: `POST /api/sentiment/vote`에서 로그인 필수. `anonymous_id` 경로 제거 또는 무시.
  - UI: 비로그인 시 “로그인하고 투표하세요” + 로그인 버튼만 노출 (투표 버튼 비활성 또는 미노출).
- **보팅코인 잔액**
  - `users` 테이블의 `virtual_cash_balance` 컬럼 이름을 `voting_coin_balance`로 변경하여 사용. 기존 값(10000) 유지.
- **RLS·인덱스**
  - 본인 잔액만 조회/갱신 가능하도록 RLS 정책 추가.

**1단계 완료 기준 (전체)**

- 로그인 사용자만 데일리(비트코인) 투표 가능.
- 사용자별 보팅코인 잔액이 DB에 있고, 초기 지급 후 조회 가능.

**선택(이 단계 이후)**

- 카카오 로그인: 이 단계에서 필수는 아니고, 로그인 전제만 만족하면 이후 단계에서 추가 가능.

---

## 2단계: 포인트 배팅 (코인 수 기반 비율)

**목표**: 유저가 **보팅코인 N개**를 걸 수 있게 하고, **롱/숏 비율은 걸린 코인 수 기준**으로 표시한다. 직관적이고 “진짜 베팅” 느낌을 주기 위함.  
고수에게 “표 수 가중치”를 주는 대신, **정산 시 승률 비례 가중만큼 추가 포인트를 지급**하는 방식은 3단계에서 설계(아래 참고).

**설계 요약**

| 구분           | 설명                                                                                                             |
| -------------- | ---------------------------------------------------------------------------------------------------------------- |
| **롱/숏 비율** | **걸린 코인 수** 기준 (long_coin_total vs short_coin_total). 1인 1표 아님.                                       |
| **정산**       | 패자 풀을 승자에게 **베팅 비율대로** 분배 (순수 파리뮤추얼). 승률은 정산에 쓰지 않고 **티어·랭킹 전용** (3단계). |
| **UI**         | 롱/숏 **코인 수 비율** 막대 + “베팅된 코인: 롱 N코인 (a%) / 숏 M코인 (b%)” 등.                                   |

**구현 내용**

- **DB**
  - `sentiment_votes`에 **`bet_amount`** (numeric, 소수 둘째자리까지. 배팅한 보팅코인 수) 추가. 최소 10코인, 최대 잔액 100% (추가 정의 참고).
  - `sentiment_polls`에 **코인 집계**: `long_coin_total`, `short_coin_total`. 기존 `long_count`/`short_count`는 인원 수 용도로 유지하거나 제거.
- **로직**
  - 투표(배팅) 시: 사용자 잔액에서 `bet_amount` 차감, `sentiment_votes`에 `choice` + `bet_amount` 저장.
  - **수정·취소**: **마감 전까지 무한 수정·취소 허용**. 방향(롱/숏) 변경·배팅 코인 수 변경·**취소(배팅 회수)** 가능. 정산은 **마감 시점 스냅샷만** 사용. 기존 배팅 반환 후 새 배팅 차감(또는 차이만 반영). 1인 1폴 1행 UPDATE로 처리.
  - **취소 기능**: 아직 미구현. 2단계 구현 시 **취소 API·UI 추가 필요** (취소 시 bet_amount=0 또는 행 삭제, 잔액 반환).
  - **1인 1폴 1투표** 유지: 한 날짜에 한 사용자당 하나의 행만 (choice + bet_amount 업데이트).
- **집계**
  - 폴별로 **베팅 코인** 합 → `long_coin_total`, `short_coin_total`. 비율 = 코인 수 비율.
- **UI**
  - “롱/숏 선택” + **“몇 코인 걸까?”** 입력(또는 버튼) 추가.
  - 롱/숏 **코인 수 비율** 막대 + “베팅된 코인: 롱 N코인 (a%) / 숏 M코인 (b%)”.

**완료 기준**

- 데일리 비트코인 투표가 “보팅코인 N개 걸기”로 동작.
- 롱/숏 비율이 **걸린 코인 수 기준**으로 노출됨.
- "마감 전까지 수정 및 취소 가능" 문구 명시. **취소 기능** API·UI 구현.

---

## 3단계: 정산 (순수 파리뮤추얼)

**목표**: 종가 확정 후, **패자 풀**을 **승자**에게 **베팅 비율대로** 분배한다.  
**승률은 정산에 쓰지 않고**, 티어·랭킹 전용으로만 사용한다. (직관적이고 단순하며, 소수 참여자의 누적 승률 100% 같은 예외도 정산에 영향 없음.)

**설계 방향**

- **정산**: 순수 파리뮤추얼. 당첨자 i 수령 = 패자\_풀 × (본인 베팅 코인 / 당첨측 총 베팅 코인).
- **승률**: 티어 시스템(배치→브론즈~), 리더보드/랭킹 표시에만 사용. 정산 공식에는 미사용.

**구현 내용**

- **종가 확정**
  - 기존처럼 다음날 KST 00:00(또는 00:01) 이후 해당일 `btc_close` 수집·저장하는 cron/job 유지.
- **정산 로직 (순수 파리뮤추얼)**
  - 해당 `poll_date`의 결과(시가·종가)로 롱/숏 당첨 여부 판정.
  - **패자 풀** = 당첨 반대쪽에 걸린 코인 전체 (롱 승리 시 숏 풀, 숏 승리 시 롱 풀).
  - **분배**: 패자 풀을 당첨자들에게 **베팅 코인 비율**로만 나눠 줌.
    - 수식: 당첨자 i의 수령 = 패자*풀*전체 × (bet*i / 당첨측*총\_베팅).
  - **수수료**: 없음. 승자는 패자 풀을 수수료 없이 비율대로 전부 가져감 (추가 정의 확정).
- **단독 참여(무효판) 처리**
  - 마감 시점 기준으로 **실제 배팅 코인(bet_amount > 0)이 걸린 유저 수가 1명 이하**인 경우, 해당 폴은 **무효판**으로 처리한다.
  - 처리 방식:
    - 모든 참여자의 `bet_amount` 전액을 원래 잔액(`users.voting_coin_balance`)으로 환불한다.
    - 해당 폴에 대해서는 **정산(payout)** 을 수행하지 않고, `payout_history`에도 기록하지 않는다.
    - 승률·티어·랭킹 계산 시 이 폴은 **참여·정답/오답 모두에서 제외**한다. (즉, 승률에 영향 없음)
- **한쪽 쏠림(한쪽만 배팅) 처리**
  - 단독 참여가 아니어도(참여자 2명 이상), **한쪽에만 배팅이 몰린 경우**(롱만 있거나 숏만 있음: `long_coin_total = 0` 또는 `short_coin_total = 0`)에는 **판은 무효로 하지 않는다.** 당첨/패자 판정과 **승률은 그대로 반영**한다.
  - 다만 **코인 지급은 하지 않는다.** 패자 풀이 없어 분배할 코인이 없으므로, 당첨자에게도 추가 코인(payout)을 지급하지 않는다. 참여자 전원에게 **배팅한 코인만 원금 환불**하고, `payout_history`에는 당첨자만 기록하되 `payout_amount = 0`으로 두거나, 정산 이력 자체를 남기지 않는 방식으로 처리한다. (구현 시 둘 중 하나로 통일)
- **잔액 반영**
  - 당첨자별 수령 코인 계산 후 `users.voting_coin_balance` 갱신.
  - 정산 이력 테이블(예: `payout_history`) 저장 → 이후 **승률·티어·랭킹** 계산용으로만 사용.
- **재실행 방지**
  - 해당 폴에 “이미 정산 완료” 플래그 두고 한 번만 실행.

**완료 기준**

- 매일 종가 확정 후 자동 정산, 당첨자 잔액이 베팅 비율대로 증가함.
- 승률은 정산에 관여하지 않으며, 티어/랭킹(6·7단계)에서만 사용됨.

### 3단계 보완: 시가·종가 매일 자동 기록 및 시장 확장 명세

- **시가·종가 자동 기록**: 투표 유무와 무관하게, **당일 시가는 당일 KST 00:01**, **당일 종가는 다음날 KST 00:01**에 API로 조회해 DB에 기록하는 프로세스를 **매일 자동** 실행한다. (상세: `docs/daily-ohlc-cron-and-polls.md`.)
- **대상 시장 확장**: 현재는 **BTC/USDT**만 위 방식으로 구현·운영한다. **BTC 시장이 정상 작동한 뒤**, **한국(코스피·코스닥)** 및 **미국(S&P500·나스닥)** 지수 시장도 **동일한 방식**(매일 시가·종가 자동 조회·DB 기록)으로 확장하여 제작·실천한다.

---

### 3단계 보완: 승률은 티어·랭킹 전용 (설계 결정)

- **결정**: 정산 시 “승률 비례 가중치”를 쓰지 않음. **승률은 티어 시스템과 랭킹(리더보드)에만 사용**.
- **이유**: (1) 순수 파리뮤추얼이 직관적이고 단순함. (2) 누적 승률을 쓰면 참여 횟수가 적은 유저가 100% 등으로 과대 반영되는 문제를 정산에 넣지 않아도 됨. (3) 고수 동기 부여는 “티어·랭킹 노출”과 “당첨 시 베팅 비율대로 더 많이 걸었으면 더 많이 받음”으로 충분히 가능.
- **일반적인 파리뮤추얼**: 경마·경기 베팅 등에서는 보통 **베팅액 비율 분배**만 사용하고, “실력 가중”은 별도 보너스나 이벤트로 두는 경우가 많음. 여기서도 정산은 단순 비율, 실력(승률)은 티어/랭킹으로만 반영하는 쪽이 깔끔함.

---

### 3단계 보완: 파리뮤추얼과 롱/숏 코인 수 불균형 (피드백)

**우려**: “롱/숏 둘 다 코인 수가 같아야 하지 않나?” → **아니요. 같을 필요 없습니다.**

- **표준 파리뮤추얼**에서는 롱 풀과 숏 풀 크기가 달라도 정산이 가능합니다.
- **롱 승리 시**: 롱 쪽에 걸었던 코인(롱 풀)은 그대로 유지하고, **패자(숏) 풀 전체**를 롱 당첨자들에게 **베팅 비율대로** 나눠 줍니다.
  - 롱 당첨자 1인 수령 = (본인 베팅 코인 / 롱 풀 총 코인) × **숏 풀 전체**.
  - 롱 풀 1000, 숏 풀 500이면, 롱 승리 시 롱 당첨자들이 500을 나눠 가짐. 롱 풀 1000은 각자 베팅액 반환 개념으로 처리하거나, “원금 반환 + 수익”으로 정리하면 됨.
- **숏 승리 시**: 숏 당첨자들이 **롱 풀 전체**를 베팅 비율대로 나눠 가짐.
  - 숏 풀 500, 롱 풀 1000이면, 숏 당첨자들이 1000을 나눠 가짐.
- 따라서 **롱/숏 코인 수를 맞출 제약은 두지 않아도 됩니다.**  
  다만 풀 크기가 극단적으로 치우치면(예: 숏 10코인, 롱 10000코인) 한쪽 당첨 시 배당이 매우 크거나 작아질 수 있으므로, **최소/최대 베팅 코인**, **풀 균형 안내 문구** 등은 운영 정책에서 고려할 수 있습니다.

**정리**: 3단계 파리뮤추얼은 “패자 풀 → 승자 풀 비율 분배”만 구현하면 되고, 롱/숏 코인 수 동일 조건은 필요하지 않음.

---

## 4단계: 3개 시장 섹션 확장

**목표**: 인간 지표를 **비트코인 / 미국 주식 / 한국 주식** 3개 섹션으로 나누고, 각 섹션별로 투표(배팅)할 수 있게 한다.

**구현 내용**

- **폴·시장 구분**
  - `sentiment_polls`에 **시장/종목 구분** 컬럼 추가 (예: `market` 또는 `symbol`: `btc`, `ndq`, `sp500`, `kospi`, `kosdaq`).
  - 또는 폴을 “날짜 + 시장” 단위로 확장해, **하루에 비트코인 1개 + 미국주식 2개(나스닥, S&P500) + 한국주식 2개(코스피, 코스닥)** 형태로 5개 폴이 생기도록 설계.
- **가격 데이터**
  - 비트코인: 기존 Binance 등 (시가/종가 KST 기준).
  - 미국 주식(나스닥, S&P500): 해당 지수/ETF의 일봉 시가·종가 수집 (데이터 소스·시간대 정의 필요).
  - 한국 주식(코스피, 코스닥): KRX 또는 유료 데이터 소스로 시가·종가 수집.
- **투표·API**
  - “오늘 비트코인”, “오늘 나스닥”, … 별로 폴 ID가 다르므로, **폴별로** 투표 요청 (`POST /api/sentiment/vote`에 `poll_id` 또는 `market`+`symbol`).
  - 사용자는 **보팅코인을 시장별로 나눠서** 걸 수 있도록 (예: 비트코인 100, 나스닥 50).
- **UI**
  - 인간 지표 영역을 **3개 블록**으로 구분: 비트코인 | 미국 주식(나스닥, S&P500) | 한국 주식(코스피, 코스닥).
  - 각 블록에서 해당 종목의 “오늘 방향”에 보팅코인 배팅.

**완료 기준**

- 3개 섹션에서 각각 (비트코인 1 + 미국 2 + 한국 2) 종목에 대해 데일리 투표·집계가 동작함.
- 종가 확정·정산도 시장별로 동일한 파리뮤추얼 로직 적용 가능한 구조.

---

## 5단계: 시장세 + 과거 데이터 시각화

**목표**: **현재 추세(장세)**를 5단계로 분류하고, **과거에 같은 장세였던 구간**에서 “일봉이 시가 대비 올랐던/내렸던 비율”을 보여줘서, 오늘 롱/숏 배팅 시 **확률적 힌트**로 쓰이게 한다.

### 시장세가 의미하는 것 (정의)

- **시장세** = **그날 예측 대상(그날 일봉 마감)**을 분류하는 것이 아님.  
  **그날 투표가 진행되는 시점의 “현재 추세”**를 말함.
- 예(비트코인): 1년 전 약 한 달간 **추세의 상승 각도**가 폭등장이었고, 그 구간의 **일봉**들은 종가 > 시가인 날이 **80%**였다.  
  **지금도 비슷한 폭등장세**라면, “과거 같은 장세일 때 일봉 상승 비율이 80%였으니, 오늘도 롱이 확률적으로 유리할 수 있다”는 **의사결정 보조**용 변수.
- 정리: **투표가 열려 있는 “지금”의 장세**를 계산하고, 과거에서 **같은 장세**로 분류된 구간들을 찾아, 그 구간들 안의 **일봉**에 대해 “종가 > 시가 비율(롱 당첨에 해당)” / “종가 < 시가 비율(숏 당첨)”을 집계해 노출.  
  → “같은 장세일 때 롱 당첨률 80%”처럼 보여 주어, 롱/숏 선택에 참고하게 함.

### 5단계 라벨

- **폭등장 · 상승장 · 횡보장 · 하락장 · 폭락장** (아래 지표·임계값으로 구간 나누기).

### 5단계를 나누는 지표 후보 (기술적·직관적)

**하나의 지표만으로 5구간**에 자연스럽게 매핑하려면, **방향(상승/하락) + 강도(약한/강한)**가 한 축에 같이 나오는 지표가 좋다. 후보는 아래와 같다.

| 지표                          | 설명                                                               | 5단계 매핑 방식                                                                                         | 직관성                                         | 비고                                                                                                  |
| ----------------------------- | ------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------- | ---------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| **N일 수익률**                | 최근 N일(예: 20~30일) 종가 기준 수익률 (%)                         | 구간 4개 임계값으로 5등분. 예: &lt;-10% 폭락, -10%~-2% 하락, -2%~+2% 횡보, +2%~+10% 상승, &gt;+10% 폭등 | ★★★★★ “한 달 전보다 얼마나 올랐나”로 설명 가능 | 자산별로 % 조정 필요(비트코인은 ±15% 등). 또는 **백분위**로 통일(상위 20%→폭등, …)하면 시장 통일 가능 |
| **선형 회귀 기울기(일별 %)**  | 최근 N일 가격을 시간으로 1차 회귀한 slope를 “일별 수익률 %”로 환산 | slope %가 음수/양수 + 크기로 5구간. “추세의 상승 각도”와 직접 대응                                      | ★★★★ “추세 각도”라는 말과 일치                 | 수익률과 유사하지만 추세선 기준이라 노이즈에 덜 흔들림                                                |
| **ADX + 방향(+DI/-DI)**       | ADX=추세 강도(0~100), +DI/-DI=상승/하락 방향                       | ADX 낮음 → 횡보. ADX 높을 때 +DI&gt;-DI → 상승/폭등(+DI 차이로 구분), -DI&gt;+DI → 하락/폭락            | ★★★★ 업계에서 “추세 강도·방향” 표준에 가까움   | 구현은 상대적으로 무거움. 5단계 컷은 ADX·DI 스프레드 임계값으로 정의                                  |
| **볼린저 밴드 위치(Z-score)** | 가격이 20일 중심선에서 몇 표준편차 위/아래인지                     | 예: Z&gt;2 폭등, 0.5~2 상승, -0.5~0.5 횡보, -2~-0.5 하락, Z&lt;-2 폭락                                  | ★★★★ 변동성 보정돼서 자산·기간 비교에 유리     | “지금 가격이 평균 대비 얼마나 극단인가”에 가깝고, “추세 지속성”은 N일 수익률보다 약함                 |

**권장(우선 구현)**

- **N일 수익률**을 1차 선택 권장.
  - 이유: “최근 한 달(또는 N일) 수익률” 하나로 5구간을 나누면 설명이 쉽고, 과거 같은 장세 매칭도 “과거 구간의 N일 수익률”만 계산하면 되어 구현이 단순함.
  - 임계값은 시장(비트코인/나스닥/코스피 등)별로 다르게 두거나, **과거 N일 수익률의 분포 백분위**(상위 20%→폭등, 그다음 20%→상승, …)로 통일하면 시장 간 비교가 가능함.

**임계값 예시(N일 수익률, 고정 %)**

- 비트코인(변동성 큼): 폭락 &lt;-12%, 하락 -12%~-3%, 횡보 -3%~+3%, 상승 +3%~+12%, 폭등 &gt;+12%.
- 지수(코스피·나스닥 등): 폭락 &lt;-5%, 하락 -5%~-1.5%, 횡보 -1.5%~+1.5%, 상승 +1.5%~+5%, 폭등 &gt;+5%.  
  (실제 값은 백테스트나 분위수로 조정 권장.)

### N일 수익률 산정 방법

**정의**

- **N일 수익률**(특정 날짜 T 기준) = (T일 종가 − T-N일 종가) / T-N일 종가 × 100 (%).
- 즉 “N일 전 종가 대비 오늘(또는 T일) 종가가 몇 % 올랐는지/내렸는지” 하나의 숫자.

**데이터**

- **일봉(일별 봉)** 시리즈에서 **시가(open)** 와 **종가(close)** 를 **둘 다** 가져와야 함.
  - **N일 수익률**(장세 분류용): 종가만 있으면 계산 가능 → (T일 종가 − T-N일 종가) / T-N일 종가.
  - **같은 장세일 때 통계**(롱/숏 당첨률): “폭등장으로 판단된 Y날들 중, 그날 **시가보다 종가가 오른 날**이 몇 %, **오르지 못한 날**이 몇 %인지”를 보려면, **각 일봉마다 그날의 시가·종가**가 필요함.
    - 종가 &gt; 시가 → 그날 일봉 상승 → 롱 당첨.
    - 종가 &lt; 시가 → 그날 일봉 하락 → 숏 당첨.
- 따라서 일봉 API에서는 **날짜별 시가·종가**를 모두 가져와야, 장세 분류와 “과거 같은 장세일 때 일봉 상승/하락 비율”을 둘 다 계산할 수 있음.

**비트코인 예시 (Binance)**

- Binance 공개 API: `GET /api/v3/klines?symbol=BTCUSDT&interval=1d&limit=400`
  - **interval=1d** → 일봉. 한 봉 = 하루.
  - 응답: 봉 배열. 각 봉 = `[ openTime, open, high, low, close, ... ]`
  - **시가** = `open` (인덱스 1), **종가** = `close` (인덱스 4). → **시가·종가 둘 다** 사용.
- **N일 수익률**(인덱스 `i`, `i >= N`): `(close[i] - close[i-N]) / close[i-N] * 100`.
- **같은 장세일 때 일봉 통계**: “폭등장”으로 라벨된 각 날짜(각 봉)에 대해 `close[i] > open[i]` 이면 롱 당첨, `close[i] < open[i]` 이면 숏 당첨으로 집계 → 비율 계산.
- 현재 프로젝트의 `btc-kst.ts`는 **1h 봉**으로 “KST 00:00 시가/종가”만 쓰고 있음. **N일 수익률·시장세·과거 같은 장세 통계**용으로는 **일봉(1d) 시리즈를 시가·종가 포함해** 별도 조회하는 것이 맞음 (Binance interval=1d).

**요약**

- N일 수익률 = (당일 종가 − N일 전 종가) / N일 전 종가 × 100.
- “과거 같은 장세일 때 롱/숏 당첨률” = 해당 장세로 분류된 날들마다 **그날 시가 vs 그날 종가** 비교 필요 → **일봉별 시가·종가 둘 다** 필요.
- 비트코인: 일봉 API에서 **날짜별 시가(open)·종가(close)** 를 가져오면, N일 수익률과 동일 장세 일봉 상승/하락 비율을 모두 계산 가능.

### 구현 방향

- **현재 장세 계산**
  - 시장(비트코인/미국주식/한국주식)별로 **최근 N일**(예: 20~30일) 구간의 **추세 지표** 1개 계산 (예: 기간 수익률, 또는 추세 각도, 이동평균 배열 등).
  - 해당 지표를 5구간으로 나누어 **현재 장세** = 폭등/상승/횡보/하락/폭락 중 하나로 분류.
- **과거 구간 라벨링**
  - 과거 일봉 데이터를 **같은 방식**으로 롤링 윈도우(예: 1달) 단위로 잘라, 각 구간마다 동일한 5단계 라벨 부여.
- **같은 장세일 때 일봉 통계**
  - “폭등장”으로 라벨된 과거 구간들 **안의 모든 일봉**에 대해:
    - (종가 > 시가인 일수) / (전체 일수) → **롱 당첨률**(일봉 상승 비율)
    - (종가 < 시가인 일수) / (전체 일수) → **숏 당첨률**(일봉 하락 비율)
  - 동률(종가=시가)은 제외하거나 반씩 배분 등 규칙 하나로 통일.
- **저장**
  - 시장·날짜별 **현재 장세** 저장(선택: `market_regime` 등).
  - 과거 구간 라벨 + 구간 내 일봉 상승/하락 비율은 **집계 결과**로 캐시 또는 마트에 저장해 두고, “같은 장세일 때 롱/숏 당첨률” 조회에 사용.
- **UI(인간 지표)**
  - “현재 시장세: 폭등장” 표시.
  - “과거 폭등장일 때: 일봉 상승(롱 당첨) 80%, 하락(숏 당첨) 20%” 형태로 **과거 같은 장세일 때 일봉 상승/하락 비율** 노출 → 확률적으로 롱/숏 중 어느 쪽이 유리했는지 의사결정 지원.

**완료 기준**

- 현재 추세가 5단계(폭등/상승/횡보/하락/폭락)로 자동 분류됨.
- 과거 같은 장세 구간에서 “일봉 상승 비율(롱 당첨률)·일봉 하락 비율(숏 당첨률)”이 집계·노출됨.
- 인간 지표 섹션에서 “현재 시장세 + 과거 같은 장세일 때 롱/숏 당첨률”을 볼 수 있음.

---

## 6단계: 티어 + 랭킹 시스템

**목표**: **티어**(배치 5판 이후 브론즈~)와 **랭킹(MMR)**을 도입해 우월감·동기 부여를 주고, 상위 1% 포지션 노출 등에 활용한다. 시즌·배치고사는 리그 오브 레전드 방식을 참고해 연 3시즌, 시즌마다 배치 재진행으로 운영한다.

**통합 랭킹 (2025-02 확정)**: MMR·랭킹·티어는 **비트코인·미국 주식·한국 주식 세 영역을 하나로 합친 통합 랭킹**으로만 운영한다. **배치고사**는 **전체 시장 중 아무 영역이든** 정산받은 5판을 채우면 완료되며, 그 결과로 MMR·티어가 확정된다. (시장별로 5판씩이 아님.)

---

### MMR 점수 정의

- **MMR 점수** = 랭킹·티어를 결정하는 단일 지표.  
  **MMR = 보유 코인 수 × 누적 승률** (누적 승률 0~1, 예: 65% → 0.65).
- 티어 구간은 **MMR 순위(백분위) 구간**으로 정의. (아래 티어 정의 참고.)
- 리더보드·상위 1% 등 모든 순위·구간은 MMR 기준.

---

### 티어 정의 (골드 → 챌린저)

**티어 순서 (낮은 순)**  
**티어 없음(배치고사 5판 필요)** (배치 미완료 시) → **골드** (가장 낮은 확정 티어) → **플레티넘** → **다이아** → **마스터** → **챌린저** (가장 높은 티어).

- 배치 5판 미만 유저에게는 “**티어 없음(배치고사 5판 필요)**”를 표시해, 배치고사를 봐야 티어가 생긴다는 것을 인지시키도록 함.

**티어 비율 (MMR 순위 백분위 기준, 배치 완료자만)**

| 티어     | 비율 정의              | 해석 예시 (전체 유저 대비)        |
| -------- | ---------------------- | --------------------------------- |
| 골드     | 상위 60%까지           | 하위 60% = 골드 (0~60 percentile) |
| 플레티넘 | 그 위부터 상위 30%까지 | 60~80 percentile (20%)            |
| 다이아   | 그 위부터 상위 10%까지 | 80~90 percentile (10%)            |
| 마스터   | 그 위부터 상위 2%까지  | 90~99 percentile (9%)             |
| 챌린저   | 상위 1%                | 99~100 percentile (1%)            |

**비율 피드백**

- 골드 60%, 플레티넘 20%, 다이아 10%, 마스터 9%, 챌린저 1%로 두면 **합이 100%** (60+20+10+9+1=100%).
- 구현 시 **해당 시즌 배치 완료 유저의 MMR 분포**를 기준으로 백분위를 계산한 뒤, 위 비율에 맞춰 티어 컷라인을 두면 됨.

---

### 시즌·배치고사 (리그 오브 레전드 참고)

**1) 시즌 구조**

- 연도를 **정확히 3등분**한 시즌으로 운영. (예: 시즌1 1~4월, 시즌2 5~8월, 시즌3 9~12월 — 구체 일자는 운영 정책에서 확정.)
- **매 시즌 시작 시, 모든 유저가 배치고사를 다시 본다.** 즉 시즌이 바뀔 때마다 최소 5판 배치를 치러야 해당 시즌의 티어·MMR이 확정됨.

**2) 시즌 전환 시 초기화·하한·상한**

- **누적 승률**: 매 시즌 **초기화**. 해당 시즌에 참여한 폴만으로 시즌 누적 승률을 다시 쌓음.
- **보유 코인**: 초기화하지 않음. (이전 시즌에서 번 코인이 그대로 유지.)
- **배치 후 MMR 보정 (하한 70%, 상한 130%)**  
  배치 5판으로 계산된 MMR을 **이전 시즌 MMR** 기준으로 보정한다.
  - **하한**: `새_MMR ≥ 이전_시즌_MMR × 0.70` (배치를 못 봐도 이전 실력을 반영해 너무 낮은 티어로만 떨어지지 않게).
  - **상한**: `새_MMR ≤ 이전_시즌_MMR × 1.30` (배치를 아주 잘 봐도 5판 운만으로 한 번에 너무 치솟지 않게).
  - 수식: `최종_MMR = clamp(배치로_계산한_MMR, 이전_MMR × 0.70, 이전_MMR × 1.30)`.
  - **설계 의도**: 배치고사가 “더 긴장하고 더 잘할 수 있게 테스트하는” 느낌이 나도록, 5판 결과가 ±30%까지 반영되게 둠. 또한 인생에서 운이 중요하다는 점을 반영해, 운이 어느 정도 개입하는 것이 오히려 현실적이라는 판단으로 70%~130% 범위를 사용함.

**3) 배치고사의 영향력**

- 시즌이 바뀌면 승률이 0부터 다시 쌓이므로, **배치 5판 결과**가 시즌 초기 승률을 크게 좌우함.
- **배치를 잘 보면** → 높은 초기 승률 → MMR 상승 (상한 130%까지) → 더 높은 티어로 올라갈 기회.
- **배치를 못 보면** → 낮은 초기 승률 → MMR 하락 (하한 70%까지).
- 이에 따라 **배치고사 결과의 영향력**을 키워, “매 시즌 배치가 중요하다”는 게임 같은 긴장감과 동기 부여를 줌.

**4) 설계 목적**

- 한국에 리그 오브 레전드 유저·팬이 많다는 점을 활용해, **게임을 하는 느낌**과 **친근함**을 주고 **진입 장벽**을 낮추기 위함.

---

### 배치 5판·티어 확정

- **누적 승률**과 **티어**는 해당 시즌에서 **전체 시장(비트코인·미국·한국)을 통틀어 최소 5판** 정산을 치른 뒤에만 확정·노출. (어느 시장이든 5판만 채우면 배치 완료.)
- **5판 미만**: 티어를 “**티어 없음(배치고사 5판 필요)**”로 표시. 배치고사를 보지 않은 유저도 이 문구를 보면 “아, 아무 시장이나 5판 정산을 해야 티어가 생기는구나”를 인지할 수 있도록 함. 누적 승률은 5판 미만일 때 MMR/티어 계산에 사용하지 않음.

---

### “코인 수가 지배적”인 설계 의도 (승부사 논리)

- MMR에서 코인 수가 큰 비중을 가지는 것은 **의도된 설계**.
- 현실에서도 트레이더는 “승률 중시” vs “손익비(포지션 사이징) 중시”로 나뉜다.
- **틀릴 때는 적게, 맞을 때는 크게** 거는 포지션 사이징을 하는 사람을 더 실력 있는 트레이더로 보는 논리를 적용. 따라서 “코인 × 승률”로 **맞을 때 크게 걸어 코인을 쌓은 사람**을 상위에 두는 구조.

---

### 구현 시 참고 사항

- **통합 랭킹**: MMR·티어·리더보드는 **시장 구분 없이** 한 묶음으로만 운영. DB에는 `user_season_stats.market = 'all'` 등 하나의 값으로 통합 통계 저장.
- **배치**: 시즌마다 **전체 시장 중** 정산 5판을 치르면 해당 시즌 배치 완료. 이후 시즌 누적 승률·티어 계산.
- **MMR**: `MMR = voting_coin_balance × 시즌_누적_승률`. 5판 미만이면 MMR 미산출 또는 0(또는 하한 보정값) 처리.
- **티어**: MMR 순위(백분위) 구간으로 **골드 → 플레티넘 → 다이아 → 마스터 → 챌린저** 정의. (비율: 골드 60%, 플레티넘 20%, 다이아 10%, 마스터 9%, 챌린저 1%, 위 표 참고.) 사용자(또는 시즌별 프로필)에 `tier`, `placement_done`, `season_cumulative_win_rate`, `season_id` 등 저장.
- **상위 1% 포지션**: MMR 기준 상위 1% 유저의 롱/숏 비율 집계·노출.
- **API**: 티어·MMR·시즌 누적 승률 조회, 상위 1% 포지션 조회.

**완료 기준**

- 시즌이 연 3회로 구분되고, 시즌마다 **통합** 배치고사(전체 시장 중 5판) 후 티어·MMR 확정.
- MMR = 보유 코인 × 시즌 누적 승률로 계산·저장되며, 배치 결과·하한 보정 반영. 리더보드/티어 UI에 **통합 랭킹**으로 반영됨.

---

## 7단계: 리더보드 + 홈 고수 포지션

**목표**: **통합 랭킹** 기준 **TOP 5** 리더보드와 **현재 포지션**(오늘 각 시장 롱/숏)을 홈에 보여 준다. (시장별 분리 없음.)

**통합 리더보드 구조**

| 구분             | 설명                                                    |
| ---------------- | ------------------------------------------------------- |
| **리더보드**     | 통합 MMR 기준 TOP 5 (비트코인·미국·한국 한 묶음)        |
| **현재 포지션**  | TOP 5 유저별 **오늘** 투표 — 비트코인·나스닥·S&P·코스피·코스닥 등 시장별 롱/숏 |

- **리더보드** → 통합 MMR TOP 5 한 개만 노출.
- "현재 포지션"은 **유저당 1개 시장만** 표시: 해당 유저가 **가장 많이 배팅한 시장** 1개 + 그 시장에서의 롱/숏·배팅 VTC.
- 각 탭에서 “현재 포지션”은 **그 시장의 오늘 투표(롱/숏)**를 의미함.

**리더보드 노출 항목 (통합 TOP 5)**

| 노출 항목           | 설명                                                                     |
| ------------------- | ------------------------------------------------------------------------ |
| 닉네임              | 유저 닉네임                                                              |
| MMR                 | 통합 랭킹·티어 점수 (보유 코인 × 시즌 누적 승률)             |
| 가진 자산(보팅코인) | 현재 보팅코인 잔액                                           |
| 누적 승률           | 해당 시즌 통합 누적 승률                                     |
| 현재 포지션         | 유저당 **가장 많이 배팅한 시장 1개** + 그 시장에서의 롱/숏·배팅 VTC |
| 배팅한 코인 수      | 위 1개 시장에서의 배팅 코인 수                                |

**구현 내용**

- **리더보드**
  - **통합** MMR 기준 **TOP 5** 조회. (`user_season_stats.market = 'all'` 등 통합 통계 사용.)
  - **닉네임, MMR, 가진 자산(보팅코인), 누적 승률, 현재 포지션, 배팅한 코인 수** 노출.
- **현재 포지션**
  - TOP 5 유저별로 **가장 많이 배팅한 시장 1개**만 조회해, 그 시장명 + 롱/숏 + 배팅 VTC 표시.
- **홈 배치**
  - 홈에서 통합 TOP 5 리더보드 + 현재 포지션 위젯 한 블록으로 노출.

**완료 기준**

- 통합 TOP 5 리더보드가 노출되고, 닉네임·MMR·가진 자산(보팅코인)·누적 승률·현재 포지션(유저당 최다배팅 시장 1개)·배팅한 코인 수가 표시됨.

---

### 통합 랭킹 DB·UI 설계 보완 (2025-02)

다음 네 가지는 구현 시 반드시 반영한다.

1. **DB market 값 구분**
   - **sentiment_polls·Cron·정산 이력**: `market`은 **btc, ndq, sp500, kospi, kosdaq** 그대로 둔다. 유저가 어디에 배팅했는지, Cron으로 어느 시장 값이 저장되는지 구분해야 하므로 `all`로 통일하지 않는다.
   - **user_season_stats**만 **market = 'all'** 한 행으로 통합 랭킹을 저장한다. 배팅·정산될 때마다 유저별 배팅/정산 횟수가 `market = 'all'` 행에 누적된다.

2. **user_season_stats**
   - 통합 랭킹이므로 **market = 'all'** 한 행만 사용. sentiment_polls·payout_history는 시장별(btc, ndq 등)로 저장되지만, user_season_stats에는 시장 구분 없이 `market = 'all'`로 upsert하여 배치 5판·MMR·티어를 계산한다.

3. **sentiment_votes에 market 컬럼 추가**
   - 현재 `sentiment_votes`에는 `choice`(방향)만 있고 **어느 시장 폴에 대한 투표인지**가 없다. **market** 컬럼을 추가하고, 투표(insert/update) 시 해당 폴의 `sentiment_polls.market` 값을 함께 저장한다. TOP5 "최다배팅 시장" 집계·시장별 통계에 필요하다.

4. **보팅맨 TOP5 실시간 포지션**
   - 순위·닉네임·포지션·배팅 VTC만 있으면 "어느 시장에 얼마나 걸었는지"가 드러나지 않는다. **유저당 1개 시장만** 보여 주며, 그 1개는 **해당 유저가 가장 많이 배팅한 시장**으로 한다. UI에는 "시장명 N VTC · 롱/숏" 형태로 표시한다.

---

### 초기 지급·MMR·랭킹·티어 (통합 랭킹 확정)

시장별 리더보드(코인 고수 / 미국 주식 고수 / 한국 주식 고수)를 제대로 나누려면 **각 시장마다 MMR·랭킹·티어를 따로 두는 것**이 자연스럽고, “배팅한 코인 수”도 시장별 폴 기준이면 이미 시장별 데이터를 쓰게 됨.

**나눌 수 있는 것**

| 항목                    | 시장별로 나눌 때                                                      | 복잡도                                                                                                             |
| ----------------------- | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **초기 지급 보팅 코인** | 시장별 잔액 3개 (비트코인용, 미국주식용, 한국주식용)                  | 높음 — 입금·이체·정산을 시장별로 처리해야 함.                                                                      |
| **보팅코인 잔액**       | 1개 유지, 모든 시장에서 공통 사용                                     | 낮음 — 현재 설계 유지.                                                                                             |
| **MMR·랭킹·티어**       | 시장별 승률만 따로 저장 → 시장별 MMR = (잔액) × (해당 시장 누적 승률) | 중간 — 시장별 승률·배치 이력 테이블 또는 컬럼 추가. 티어도 시장별로 두면 “비트코인 골드, 미국주식 다이아”처럼 3개. |

**현재 확정: 잔액 1개 + 통합 MMR·랭킹·티어 (2025-02)**

- **보팅코인 잔액은 1개**로 유지. 모든 투자자의 **시드머니도 1개**이며, 그 하나의 자산으로 **어떤 포트폴리오(어떤 시장에 얼마나 걸지)**로 투자할지는 각자의 자유다. 따라서 잔액·초기 지급은 시장별로 나누지 않음.
- **MMR, 랭킹, 티어는 통합**으로만 둠. DB에는 `user_season_stats.market = 'all'` 한 행만 사용. 시즌 누적 승률·배치 5판·시즌 전환·하한/상한은 **전체 시장(비트코인·미국·한국) 정산 폴 합산**으로 계산. “해당 시장 폴”만으로 계산.
- **티어**는 1개 (예: 골드, 플레티넘 …). 리더보드도 통합 TOP 5 한 개만 노출.

*(과거 검토했던 "시장별 MMR·티어" 옵션은 채택하지 않음. 통합 랭킹으로 단순화.)*

---

### 보팅코인 시스템 추가 정의 (확정)

| 항목                        | 확정 내용                                                                                                                                       |
| --------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| **신규 유저(첫 시즌 배치)** | 이전 시즌 MMR이 없으므로 70%~130% 적용 불가. **첫 시즌 규칙은 배치 5판 결과만 반영**하여 MMR·티어 부여.                                         |
| **통합 배치 5판**           | **전체 시장 통합.** 아무 시장이든 정산 5판을 치르면 배치 완료. **매 시즌마다 초기화.**                                                          |
| **정산 수수료**             | **승자는 수수료를 떼지 않음.** 패자 풀을 수수료 없이 비율대로 가져감.                                                                           |
| **최소·최대 배팅 코인**     | **최소 10코인, 최대 100%(전부) 배팅 가능.** 어뷰징 방지는 현재 단계 미적용, 추후 업데이트 시 검토.                                              |
| **동시 배팅**               | **가능.** 배팅할 때마다 **즉시 잔액 차감.** 잔액 범위 내에서 여러 시장에 자유롭게 배팅.                                                         |
| **배팅한 코인 수 표시**     | 리더보드뿐 아니라 **자기 자신이 배팅한 코인 수**도 표시 (내 배팅 현황 확인용).                                                                  |
| **소수점 배팅**             | 패자 풀 비율 분배 시 소수점 수령이 발생할 수 있으므로 **배팅도 소수점 허용. 소수점 둘째자리까지만.** (DB·API에서 numeric(10,2) 또는 동등 처리.) |

---

### 추가 의견 (구현 참고)

**1) 어뷰징 방지 — 현재 단계 미적용 (확정)**

- **결정**: 지금 단계에서는 **어뷰징 방지(IP 제한, 전화번호 인증 등)를 적용하지 않음**. 유저도 없는 상황에서 선행 개발은 시간 낭비. **훗날 서비스가 잘 되었을 때** 업데이트를 통해 도입할 일.
- **계정·로그인 정책 (확정)**: **구글 회원가입 + 카카오 회원가입** / **구글 로그인 + 카카오 로그인**만 제공. 그 외 소셜·전화번호·이메일 직접 가입은 두지 않음.
  가입 직후 0으로 두고 “첫 로그인 후 24시간 경과” 또는 “첫 배팅 시점”에 초기 코인 지급 — 봇성 일괄 가입을 줄이는 데 도움.

**2) 배팅 수정·취소 가능 여부 (확정)**

- **수정/취소 가능**으로 두면: 마감 전까지 **방향 변경**(롱↔숏) 또는 **배팅 코인 수 변경** 또는 **취소(배팅 0으로)**가 가능. 기존 투표가 “같은 날 수정 가능”이었으므로, 배팅도 “같은 폴에 대해 1행 유지, UPDATE로 변경”이면 **복잡도는 크지 않음.**
  - 로직: 배팅 시 기존 행이 있으면 UPDATE(choice, bet_amount), 없으면 INSERT. 취소 시 bet_amount=0 또는 행 삭제(정책에 따라). 잔액은 “기존 배팅 반환 + 새 배팅 차감” 또는 “차이만 반영”으로 처리.
  - **마감 시각 전에만** 수정/취소 허용하면, 정산 로직은 “마감 시점의 스냅샷”만 보면 되므로 설계가 꼬이지 않음.
- **결론**: 수정·취소 가능하게 두어도 **마감 전 1인 1폴 1행 + UPDATE**로 일관되게 처리하면 복잡도는 중간 이하. 사용자 경험상 “실수로 잘못 걸었을 때 고칠 수 있다”는 편이 좋으므로, **마감 전 수정·취소 허용**을 권장함.

**3) 미국 주식·한국 주식 시장 투표/마감 시간 (재제안)**

- **비트코인**: 24시간 거래이므로 “KST 00:00 시가 ~ 다음날 00:00 종가, 투표 마감 22:30”처럼 **일봉·마감을 KST 기준으로 고정**하기 쉬움.
- **미국 주식(나스닥, S&P500)**:
  - **미국 거래 시간**이 정해져 있음 (예: NYSE/NASDAQ 09:30~16:00 ET).
  - **아이디어 A**: “오늘 미국 일봉” = 해당일 미동부 기준 시가·종가. **투표 마감** = 해당일 미동부 16:00 직후(예: KST 다음날 06:00) 또는 “한국 기준 당일 22:00”처럼 KST 고정.
  - **아이디어 B**: “오늘 미국 장 중”에만 투표 가능 (09:30~16:00 ET) — 구현·안내가 다소 복잡.
  - **권장**: **아이디어 A**. “오늘 미국 일봉의 방향”(당일 09:30 시가 → 16:00 종가)을 예측하는 폴로 두고, **투표 마감은 KST 당일 22:00 또는 22:30**으로 통일. 그러면 비트코인과 같은 “자정~마감” UX를 유지할 수 있음. (데이터는 미국 장 종료 후 수집.)
- **한국 주식(코스피, 코스닥)**:
  - **한국 거래 시간** 09:00~15:30 KST.
  - **아이디어**: “오늘 한국 일봉” = 당일 09:00 시가 → 15:30 종가. **투표 마감** = **15:30 직후(예: 15:35 KST)** 또는 “당일 22:30”으로 비트코인과 통일.
  - **권장**: **마감 15:35 KST**로 두면 “한국 장이 끝나자마자 오늘 결과가 나온다”는 직관과 맞고, **22:30으로 통일**하면 “세 시장 모두 자정~밤에 투표”로 UX 단순화. 운영 정책에 따라 선택 (직관은 15:35, 단순화는 22:30).
- **정리**:
  - **비트코인**: KST 00:00~22:30 투표, 다음날 00:00 종가 확정 (기존 유지).
  - **미국 주식**: “당일 미국 일봉” 예측, **투표 마감 KST 22:00 또는 22:30** (미국 장 종료는 KST 다음날 새벽이므로, 전날 일봉은 “어제”로 두고 당일 폴은 “오늘 미국 장” 기준으로 정의).
  - **한국 주식**: “당일 한국 일봉” 예측, **투표 마감 15:35 KST(장 마감 직후)** 또는 **22:30 KST(비트코인·미국과 통일)**.

### 추가 의견 요청 답변 및 최종 확정 (2025-02)

**어뷰징 방지 — 현재 단계 미적용**

- **확정**: 지금 단계에서는 **어뷰징 방지(IP 제한, 전화번호 인증 등) 미적용**. 훗날 잘 되었을 때 업데이트로 진행. **회원가입·로그인은 구글 + 카카오만** (구글 회원가입/로그인, 카카오 회원가입/로그인).

**배팅 수정·취소**

- **확정**: 마감 전까지 **수정·취소 가능**. 정산은 마감 시점 스냅샷만 사용. 취소 기능은 2단계에서 API·UI 구현.

**시장별 투표 마감 시간 (최종 확정)**

| 시장          | 일봉 종가 시점 (KST)    | 투표 마감 (KST) | 비고                                                                    |
| ------------- | ----------------------- | --------------- | ----------------------------------------------------------------------- |
| **비트코인**  | 다음날 00:00            | **12:00**       | 봉 절반(12시간)에 마감                                                  |
| **한국 주식** | 당일 15:30              | **13:00**       | 장 마감 15:30 이전                                                      |
| **미국 주식** | 다음날 **06:00** (일괄) | **03:30**       | 서머타임 시 실제 종가는 05:00이지만, 일괄 6시로 두고 추후 업데이트 가능 |

- **미국 주식 일봉**: 서머타임에는 5시(KST)까지지만 **일괄 6시 KST**로 정함. 서머타임 대응은 추후 업데이트로 처리.

---

## 단계별 의존 관계 (재정의 반영)

```
1 (DB·스키마 기초 확정)
  → 2 (로그인 전제 + 보팅코인)
  → 3 (포인트 배팅 + 취소)
  → 4 (정산 파리뮤추얼)
  → 5 (3개 시장 확장) ← 여기까지: 3개 시장 모두 데일리 배팅→정산(end-to-end) 완료
  → 6 (시장세 + 과거 시각화)
  → 7 (티어·MMR)
  → 8 (리더보드 + 홈)
```

- **1→2→3→4** 순서 고정: 스키마 기초 없이 배팅·정산 구현 시 나중에 스키마 변경이 반복됨. 포인트 배팅 없이 정산 불가.
- **5**는 4까지 한 시장(비트코인)에서 검증된 뒤, 시장 구분·마감만 확장.
- **6·7·8**은 5 위에 부가 기능·UI 순으로 진행.

---

## 8단계 남은 작업 및 완료 후 할 일

### 8단계 남은 작업 (리더보드 + 홈)

- **7단계(티어·MMR)** 와 **8단계 UI(리더보드·홈 위젯)** 는 구현된 상태.
- **8단계에서 아직 남은 것**: 아래 위젯들의 **더미 → 실데이터 연동**.
  - **보팅맨 TOP5 랭커 실시간 포지션**: 시장(탭)별·지수별 MMR/랭킹 API 연동 후 TOP5 + 현재 포지션·배팅 코인 수 표시.
  - **비트멕스 리더보드 TOP5**: 외부 API 또는 자체 집계 서버 연동 후 실데이터 표시.
  - **코인 유튜버 실시간 포지션(인플루언서)**: 크롤러/연동 API + 캐싱 전략 수립 후 실데이터 표시.

### 6단계 현황

- **6단계(시장세 + 과거 데이터 시각화)** 는 8단계보다 앞선 단계. 아직 미구현이면 8단계 실데이터 연동 전에 6단계 완료를 권장.

---

### 기획서 해야 할 리스트 (8단계 완료 후)

8단계(리더보드 + 홈)까지 **실데이터 연동까지 완료한 뒤** 진행할 작업 목록.

| 순서 | 항목 | 내용 |
| ----- | ------ | ----- |
| 1 | **더미 → 실데이터 연동** | 보팅맨 TOP5, 비트멕스 리더보드, 인플루언서 포지션 각각 API·캐싱 설계 후 연동. |
| 2 | **모바일/태블릿 반응형 마무리** | 768px·1024px 구간에서 좌우 사이드 카드 순서/폭, 긴 닉네임·코인 수 깨짐 여부 점검 및 `sm`/`md` 브레이크포인트 정리. |
| 3 | **로딩/에러/빈 상태 처리** | 홈 상단 인간 지표·좌우 카드 등 API 연동 구간에 로딩 스피너/스켈레톤, 에러 메시지+재시도, 데이터 없을 때 빈 상태 UI 공통 패턴 적용. |
| 4 | **티어·MMR 연동 UX** | 배팅 후 시즌 통계/티어 반영 시점 정리, 티어 변화 시 사용자 알림(토스트/배지 등) 정책 수립 및 반영. |
| 5 | **성능/쿼리/보안 점검** | 홈·리더보드 등 다중 정보 조회 시 API 호출 수 최소화(배치·캐싱), Supabase RLS/권한 정책 검토, 클라이언트 대량 정렬/필터 제거. |
| 6 | **디자인/카피 파이널** | 카드 타이틀·서브타이틀·컬럼명·툴팁 톤 통일, "(더미)" 등 실서비스용 텍스트 세트 확정. |

---

### 지금 가장 시급한 것

- **6단계(시장세 + 과거 시각화)** 가 아직 미구현이면 → **6단계 완료**를 가장 먼저 진행하는 것을 권장. (8단계 실데이터보다 기반 기능이 먼저.)
- **6단계가 이미 완료**된 상태라면 → **8단계 실데이터 연동**(보팅맨 TOP5, 비트멕스 리더보드, 인플루언서 포지션)이 **가장 시급**합니다. 현재 홈·리더보드 UI는 더미 기준이라, 여기에 실제 데이터를 붙여야 서비스가 완성됩니다.

---

## 문서 이력

- 최초 작성: 보팅맨 서비스 단계별 구현 계획 정리 (기획서 및 인간 지표 DB 설계 반영).
- 2025-02: 추가 의견 요청 답변 반영 — 어뷰징(IP 현황·가능 여부), 전화번호 인증 의견, 배팅 마감 전 수정·취소 확정·취소 기능 구현 필요, 미국/한국 주식 일봉 KST 표기·투표 마감 재제안(종가 이전). 2단계 구현 내용에 수정·취소·취소 API·UI 보완.
- 2025-02: 최종 확정 — 어뷰징 방지 현재 단계 미적용(훗날 업데이트). 회원가입/로그인 **구글 + 카카오만**. 배팅 수정·취소 가능. 시장별 투표 마감: 비트코인 1d **12:00**, 한국 주식 **13:00**, 미국 주식 **03:30** KST. 미국 일봉 종가 일괄 6시 KST(서머타임 추후 업데이트). 비트코인 1d 마감 12:00 코드 반영.
- 2025-02: 구현 단계 재정의 — 순서 기준 "가장 기초·다른 영역 초석·나중에 수정 최소화". 8단계로 재구성: 1 DB·스키마 기초 확정 → 2 로그인+보팅코인 → 3 포인트 배팅+취소 → 4 정산 → 5 3개 시장 → 6 시장세 시각화 → 7 티어·MMR → 8 리더보드+홈. 새 1단계 작업 목록(1.1~1.6) 및 단계–문서 대응표 추가.
- 2025-02: 시장세 정의 보완 — 시장세는 "그날 일봉 마감 분류"가 아니라 **현재 추세(장세)**. 과거 같은 장세 구간에서 **일봉 상승/하락 비율(롱·숏 당첨률)**을 집계해 의사결정 지원. 5단계 섹션에 정의·구현 방향 반영.
- 2025-02: 시장세 5단계 지표 후보 추가 — N일 수익률(권장), 선형회귀 기울기, ADX+DI, 볼린저 Z-score 비교표 및 임계값 예시(비트코인/지수) 정리.
- 2025-02: 시장세용 일봉 데이터 — N일 수익률뿐 아니라 "과거 같은 장세일 때 그날 시가 대비 종가 상승/하락 비율" 집계를 위해 **일봉별 시가(open)·종가(close) 둘 다** 필요하다고 명시. N일 수익률 산정 방법 절 보완.
- 2025-02: **8단계 남은 작업 및 완료 후 할 일** 섹션 추가 — 8단계 실데이터 연동(보팅맨 TOP5, 비트멕스 리더보드, 인플루언서) 남은 작업 정리. 8단계 완료 후 기획서 해야 할 리스트 6항목(더미→실데이터, 반응형, 로딩/에러/빈 상태, 티어 UX, 성능/보안, 디자인/카피) 표로 기록. 가장 시급한 것: 6단계 미완이면 6단계 완료, 완료 시 8단계 실데이터 연동.