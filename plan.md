# 보팅맨 TDD 플랜 (6단계 & 8단계)

이 문서는 `CLAUDE.md`에서 참조하는 **plan.md**로,  
현재는 보팅맨의 **6단계(시장세 + 과거 데이터 시각화)** 와 **8단계(리더보드 + 홈)** 구현을 위한 TDD 작업 목록만 포함합니다.

각 항목은 **테스트 관점의 작업 단위**입니다.  
다음 규칙으로 사용합니다.

- 아직 구현 전: `- [ ] Test: ...`
- 테스트와 기능이 모두 구현·검증 완료: `- [x] Test: ...`

`"go"`라고 하면, 위에서부터 **체크되지 않은 다음 테스트**를 선택해:
1) 해당 테스트를 작성하고 (또는 보완하고)  
2) 그 테스트를 통과시키는 최소한의 코드를 구현한 뒤  
3) 필요 시 리팩터링합니다.

---

## 6단계: 시장세 + 과거 데이터 시각화

**목표 요약**  
- 현재 시장(비트코인/미국/한국)의 **최근 N일 수익률** 기반으로 **5단계 시장세(폭등·상승·횡보·하락·폭락)** 를 자동 분류한다.  
- 과거 데이터를 같은 방식으로 라벨링해서, **같은 시장세였던 구간의 일봉 상승/하락 비율(롱/숏 당첨률)** 을 집계하고, 인간 지표 UI에서 보여 준다.

**참고 문서**  
- `docs/votingman-implementation-phases.md` 의 **"5단계: 시장세 + 과거 데이터 시각화"** 섹션

### 6단계 – 백엔드/도메인 로직 테스트

- [ ] **Test: N일 수익률 계산**  
  - 주어진 일봉 시리즈(날짜별 시가/종가)와 기간 N에 대해,  
    - `(당일 종가 − N일 전 종가) / N일 전 종가 × 100` 으로 N일 수익률을 계산하는 함수가 올바르게 동작한다.

- [ ] **Test: N일 수익률 → 5단계 시장세 매핑**  
  - N일 수익률이 주어졌을 때,  
    - 비트코인 / 지수 각각에 대해 정의한 임계값에 따라  
      - 폭락/하락/횡보/상승/폭등 중 하나로 정확히 분류된다.

- [ ] **Test: 현재 날짜의 시장세 계산**  
  - 특정 시장(BTC/NDQ/SP500/KOSPI/KOSDAQ)에 대해 최근 N일 일봉 데이터가 주어졌을 때,  
    - 가장 최신 일자 기준으로 **현재 시장세 라벨**이 5단계 중 하나로 리턴된다.

- [ ] **Test: 과거 구간 라벨링 (롤링 윈도우)**  
  - 충분히 긴 일봉 시리즈와 기간 N이 주어졌을 때,  
    - 롤링 윈도우 방식으로 각 날짜(or 구간)에 대해 시장세 라벨을 계산하고,  
    - 결과가 기대한 5단계 분포(예: 테스트용 작은 데이터셋에 대한 수동 계산)와 일치한다.

- [ ] **Test: 같은 시장세 구간에서 일봉 상승/하락 비율 집계**  
  - 일봉 시리즈와 각 날짜의 시장세 라벨이 주어졌을 때,  
    - 특정 시장세(예: 폭등장)에 해당하는 날짜들의  
      - (종가 > 시가) 비율 = 롱 당첨률  
      - (종가 < 시가) 비율 = 숏 당첨률  
      이 올바르게 계산된다 (동가 처리 규칙 포함).

- [ ] **Test: 시장·날짜별 시장세 및 통계 저장/조회**  
  - DB 또는 캐시 레이어에  
    - 시장·날짜별 현재 시장세  
    - 시장세별 과거 일봉 상승/하락 비율  
    을 저장/업데이트하고, 동일한 값을 다시 조회할 수 있다.

### 6단계 – API 및 UI 연동 테스트

- [ ] **Test: 시장세/통계를 반환하는 API**  
  - 특정 시장(예: BTC)과 기준 날짜(오늘)가 주어졌을 때,  
    - API가 `현재 시장세` 와 `해당 시장세에서의 과거 롱/숏 당첨률` 을 응답 형식(`{ success: true, data: ... }`)에 맞춰 반환한다.

- [ ] **Test: 인간 지표 UI – 현재 시장세 표시**  
  - 홈 화면 인간 지표 섹션에서,  
    - API 응답에 따라 “현재 시장세: 폭등장/상승장/…” 텍스트가 올바르게 렌더링되고,  
    - 로딩/에러/빈 상태/성공 상태가 모두 처리된다.

- [ ] **Test: 인간 지표 UI – 과거 같은 장세 롱/숏 당첨률 표시**  
  - 인간 지표 섹션에서,  
    - “과거 같은 장세일 때 롱/숏 당첨률” (예: 롱 80%, 숏 20%) 이 API 응답과 일치하게 표시되고,  
    - 데이터가 없을 때는 의미 있는 빈 상태 메시지를 보여 준다.

---

## 8단계: 리더보드 + 홈

**목표 요약**  
- **통합 MMR(보유 코인 × 시즌 누적 승률)** 기준 **TOP 5 리더보드**를 만든다.  
- 각 TOP 5 유저당 **가장 많이 배팅한 시장 1개**를 골라, 오늘 그 시장에서의 **현재 포지션(롱/숏) + 배팅 코인 수(VTC)** 를 홈에서 보여 준다.

**참고 문서**  
- `docs/votingman-implementation-phases.md` 의 **"7단계: 리더보드 + 홈 고수 포지션"** 및  
  **"통합 랭킹 DB·UI 설계 보완 (2025-02)"**, **"초기 지급·MMR·랭킹·티어 (통합 랭킹 확정)"** 섹션

### 8단계 – 백엔드/도메인 로직 테스트

- [ ] **Test: user_season_stats 통합 MMR 계산**  
  - `voting_coin_balance` 와 시즌 누적 승률이 주어졌을 때,  
    - `MMR = voting_coin_balance × 시즌_누적_승률` 이 정확히 계산·저장된다.  
    - 5판 미만일 때는 MMR이 계산되지 않거나 0/기본값으로 처리된다.

- [ ] **Test: 시즌별 배치 5판 완료 여부 및 티어 상태**  
  - 정산 이력이 여러 판 있는 상황에서,  
    - 전체 시장 합산 기준 5판 미만이면 `placement_done = false` 및 “티어 없음(배치고사 5판 필요)” 상태가 유지되고,  
    - 5판 이상이면 `placement_done = true` 로 전환되며, 티어 계산의 대상이 된다.

- [ ] **Test: MMR 순위별 티어 구간 배정**  
  - 여러 유저의 MMR 값이 주어졌을 때,  
    - 상위 60% 골드, 그 위 20% 플레티넘, 10% 다이아, 9% 마스터, 상위 1% 챌린저로 구간이 올바르게 나뉜다.

- [ ] **Test: 통합 TOP 5 조회 (market = 'all')**  
  - `user_season_stats.market = 'all'` 기준으로,  
    - MMR 상위 5명의 사용자 정보(닉네임, MMR, 보유 코인, 시즌 누적 승률)가 정렬된 상태로 조회된다.

- [ ] **Test: 각 유저의 최다 배팅 시장 1개 선택**  
  - `sentiment_votes` (또는 관련 집계) 데이터가 주어졌을 때,  
    - 유저별로 **가장 많이 배팅한 시장 1개**를 정확히 계산하고,  
    - 그 시장에서의 오늘 배팅 코인 수와 롱/숏 방향이 올바르게 집계된다.

- [ ] **Test: 리더보드 API 응답 구조**  
  - 리더보드 API가 호출되면,  
    - TOP 5 유저에 대해  
      - 닉네임, MMR, 가진 자산(보팅코인), 누적 승률, 현재 포지션(시장명 + 롱/숏 + VTC), 배팅한 코인 수  
      가 CLAUDE 규칙의 응답 형식(`{ success: true, data: ... }`)으로 반환된다.

### 8단계 – 홈/리더보드 UI 테스트

- [ ] **Test: 홈 – 리더보드 위젯 로딩/에러/빈/성공 상태**  
  - 홈 화면의 리더보드 섹션에서,  
    - API 호출 중에는 로딩 UI 또는 스켈레톤이 보이고,  
    - 에러 시 에러 메시지 + 재시도 버튼이 표시되며,  
    - 데이터가 없을 때는 빈 상태 UI가,  
    - 데이터가 있을 때는 TOP 5 카드가 정상 렌더링된다.

- [ ] **Test: 홈 – TOP 5 랭커 정보 렌더링**  
  - API에서 리더보드 데이터를 받아 왔을 때,  
    - 각 랭커 카드에 닉네임, 티어/랭킹(필요 시), MMR, 가진 자산(보팅코인), 시즌 누적 승률이 올바르게 표시된다.

- [ ] **Test: 홈 – TOP 5 랭커 실시간 포지션 렌더링**  
  - API 응답에 포함된 “현재 포지션” 정보(시장명 + 롱/숏 + 배팅 VTC)를 기반으로,  
    - 유저당 1개 시장만 “시장명 N VTC · 롱/숏” 형태로 정확히 표시된다.

- [ ] **Test: 반응형 레이아웃(필요 최소 한 가지 뷰포트)**  
  - 기준 뷰포트(예: 모바일 또는 태블릿)에서 리더보드/포지션 카드가 깨지지 않고,  
    - 긴 닉네임·코인 수가 UI를 망가뜨리지 않는 최소한의 스타일이 적용되어 있다.

