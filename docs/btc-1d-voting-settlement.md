# 1일봉(btc_1d) 투표·수집·정산 정리 (확인용)

## 0. 목표가(price_open)가 반영되는 시각 (요약)

- **btc_1d의 “현재 봉”은 UTC 00:00 기준**으로 바뀐다. (`getCurrentCandleStartAt("btc_1d")` → 오늘 **UTC** 날짜의 00:00 캔들)
- 따라서 **목표가(이전 봉 종가)가 “새 날짜”로 바뀌는 시각**은 **09:00 KST (00:00 UTC)** 이다.
- **00:02 KST**에 확인했을 때 전날 목표가가 그대로 보이는 것은 정상이다.  
  그 시각에는 아직 UTC가 전날이므로 “현재 봉”이 바뀌지 않았고, 따라서 목표가도 이전 봉(그 이전 UTC일 종가)으로 유지된다.
- **09:00 KST**를 지나야 UTC 날짜가 바뀌고, 그때부터 “오늘 UTC” 1일봉이 현재 봉이 되며, 목표가 = 방금 마감된 봉(전날 UTC 00:00 봉)의 종가로 반영된다.  
  (해당 봉은 btc_ohlc에는 다음날 00:01 KST 크론에서 들어가므로, 09:00 직후에는 Binance fallback으로 목표가를 가져올 수 있다.)

---

## 1. 맞는 부분

### 1) 데이터 수집 시점
- **한국 시각 00:01**에 크론 실행 (Vercel cron: `1 15 * * *` = UTC 15:01 = KST 00:01).
- 이때 수집하는 1d 봉은 **"어제 UTC 날짜"**에 해당하는 **한 개** 봉이다.
- 예: **2월 13일 00:01 KST** 실행 시
  - 현재 UTC = 2월 12일 15:01
  - `yesterdayUtc` = **"2026-02-11"**
  - 수집 봉: `candle_start_at = 2026-02-11T00:00:00.000Z`  
    → Binance 1d 1개 (2/11 00:00 UTC ~ 2/12 00:00 UTC)
- 즉 **방금 마감된 봉**(UTC 00:00에 마감된 봉)을 00:01 KST에 수집하는 게 아니라, **“어제 UTC”** 날짜의 봉 = **그 UTC일 00:00에 시작해 다음날 UTC 00:00에 마감된 봉**을 수집한다.  
  그 봉은 실제로 **전날 UTC 00:00 = 당일 KST 09:00**에 이미 마감되어 있으므로, 00:01 KST에 수집할 때는 최종 데이터가 이미 나와 있다.

### 2) 정산 로직
- **이전 봉 종가(reference_close)** vs **방금 수집한 봉 종가(settlement_close)** 로 올랐는지/내렸는지 계산한다.  
  코드와 의도대로 동작한다.

### 3) 투표 시간
- **시작: KST 00:00**  
- **마감: KST 12:00**  
- 12시간 투표 가능 맞다.

### 4) 정산 시각
- **다음날 KST 00:01**에 크론이 돌면서 **수집 직후** 그 봉에 대해 정산한다.  
  “1분 차이”는 “투표 마감 12:00 → 다음날 00:01에 정산” 사이의 시간 차이를 말하는 것이고, 로직상 문제 없다.

### 5) 데이터 저장·표시 시 계열
- `candle_start_at`은 UTC 유지, 정산·기록·UI용 시각은 KST 기준으로 맞춰 두었으므로, “정산 및 기록은 모두 KST”라고 보면 된다.  
  단, **poll_date(예측 대상일)** 은 btc_1d일 때 **UTC 날짜**로 저장되는 부분이 있어, 아래 “교정”에서 정리한다.

---

## 2. 교정·헷갈리기 쉬운 부분

### 1) “09:00 전에는 이전 봉 데이터가 없는가?”

- Binance 1d 봉은 **UTC 00:00에 마감** = **KST 09:00에 마감**이다.
- 따라서 **그 봉의 종가**는 **KST 09:00이 되어야** 나온다.  
  → **맞다. 09:00 전에는 그 “이전 봉”(해당 1d 봉)의 종가 데이터는 없다.**
- 다만 우리는 **그 봉을 09:00에 정산하지 않고, 다음날 KST 00:01**에 크론으로 수집·정산한다.  
  정산 시점에는 이미 그 봉이 KST 09:00에 마감된 지 여러 시간 지났으므로, **정산 시점에는 데이터가 이미 있는 상태**이고, “09:00 전에 데이터가 없다”는 것은 “그 봉이 마감되는 시점”에 대한 설명으로만 이해하면 된다.

### 2) btc_1d의 poll_date는 UTC 날짜

- 코드에서 **btc_1d**만 **poll_date = 오늘의 UTC 날짜**(`getTodayUtcDateString()`)로 저장한다.
- 예:
  - **KST 2월 12일 00:00**에 “오늘 1d 폴”을 열면  
    그때 UTC = 2월 11일 15:00 이므로  
    `poll_date` = **"2026-02-11"** (UTC),  
    `candle_start_at` = **2026-02-11T00:00:00.000Z**
  - 즉 한국 사용자 입장에서는 “2월 12일에 투표하는 폴”인데, DB/API의 **예측 대상일(poll_date)** 은 **2월 11일**로 찍힌다.
- 정산할 때는 `yesterdayUtc`로 같은 **"2026-02-11"** 폴을 찾아 정산하므로 **로직은 맞다.**  
  다만 **UI에서 “예측 대상일”을 그대로 보여주면** “2월 12일에 투표했는데 예측 대상일이 2월 11일로 보인다”처럼 **혼란**이 생길 수 있다.
- **권장**: btc_1d도 **표시용**으로는 “이 봉이 마감되는 KST 날짜”(또는 candle_start_at을 KST로 해석한 날짜)로 보여주고, 내부적으로만 poll_date(UTC)를 쓰는 쪽이 이해하기 쉽다.

### 3) 00:00과 00:01 사이

- **KST 00:00**: 새 날짜가 되면서 **“오늘 1d 폴”**이 열린다 (같은 candle_start_at 유지되다가, 00:00을 넘기면 `todayUtc`가 바뀌며 새 폴이 될 수 있음 – 1d는 UTC 날짜 기준이라 09:00 KST를 넘어야 UTC 날짜가 바뀌는 건 아님. 실제로는 **KST 00:00**일 때 아직 UTC는 전날이므로 **같은 폴**이 유지됨).
- **KST 00:01**: 크론 실행 → **“어제 UTC”** 봉 수집 + 그 봉에 대한 정산.
- 따라서 “00:00에는 투표 시작, 00:01에 정산”이라는 말은 **서로 다른 봉**에 대한 것이다.  
  - 00:00: “오늘(UTC 기준으로는 아직 전날) 1d 폴”이 진행 중.  
  - 00:01: “방금 수집한 봉 = 어제 UTC 봉”에 대해 정산.  
  이 둘을 구분해 두면 1분 차이로 인한 혼란을 줄일 수 있다.

---

## 3. 시간대 요약 (1d)

| 시점 (KST)     | UTC                    | 의미 |
|----------------|------------------------|------|
| 2/12 00:00     | 2/11 15:00             | 1d 투표 시작 (해당 폴의 candle = 2/11 00:00 UTC ~ 2/12 00:00 UTC) |
| 2/12 09:00     | 2/12 00:00             | 그 1d 봉 **마감** → 종가 확정 (이때부터 해당 봉 데이터 있음) |
| 2/12 12:00     | 2/12 03:00             | 1d 투표 마감 |
| 2/13 00:01     | 2/12 15:01             | 크론: “어제 UTC”(2/11) 봉 수집 + 정산 → 방금 수집한 봉 = 2/11~2/12 UTC 봉 |

정리하면:
- **데이터 수집**: 한국 시각 00:01에 **candle_start_at(UTC)** 기준으로 “어제 UTC” 1d 봉 1개 수집. ✅  
- **정산**: 그 수집한 봉의 **이전 봉 종가 vs 이 봉 종가**로 계산. ✅  
- **투표**: 00:00 시작, 12:00 마감. ✅  
- **09:00**: 해당 1d 봉이 마감되는 시점이라, 09:00 전에는 그 봉의 종가는 없다. ✅  
- **오류 가능성**: btc_1d에서 **poll_date를 UTC로 저장**하고 그대로 “예측 대상일”로 쓰면, 한국 사용자에게 날짜가 하루 전처럼 보일 수 있음 → **표시만 KST/의미에 맞게 보정**하는 것을 권장.

이 문서는 현재 코드와 명세를 기준으로 한 “1d 봉 투표·수집·정산” 최종 확인용이다.
